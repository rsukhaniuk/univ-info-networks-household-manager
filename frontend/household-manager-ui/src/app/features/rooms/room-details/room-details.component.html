<div class="container room-details-container">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a routerLink="/households" class="text-decoration-none">
              <i class="fas fa-home me-1"></i>My Households
            </a>
          </li>
          @if (household) {
          <li class="breadcrumb-item">
            <a [routerLink]="['/households', household.id]" class="text-decoration-none">
              {{ household.name }}
            </a>
          </li>
          }
          <li class="breadcrumb-item">
            <a
              [routerLink]="['/rooms']"
              [queryParams]="{ householdId: householdId }"
              class="text-decoration-none"
            >
              Rooms
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            {{ roomDetails?.room?.name || 'Loading...' }}
          </li>
        </ol>
      </div>
    </div>
  </nav>

  <!-- Content -->
  @if (roomDetails) {
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Room Header -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <div class="d-flex align-items-start">
                <!-- Photo -->
                @if (roomDetails.room.photoUrl) {
                <div class="me-4">
                  <img
                    [src]="roomDetails.room.photoUrl | photoUrl"
                    [alt]="roomDetails.room.name"
                    class="rounded shadow-sm"
                    style="width: 120px; height: 120px; object-fit: cover"
                  />
                </div>
                } @else {
                <div
                  class="bg-light rounded d-flex align-items-center justify-content-center me-4 shadow-sm"
                  style="width: 120px; height: 120px"
                >
                  <i class="fas fa-door-open text-muted fa-2x"></i>
                </div>
                }

                <!-- Info -->
                <div class="flex-grow-1">
                  <h1 class="h3 mb-2">{{ roomDetails.room.name }}</h1>
                  @if (isSystemAdmin) {
                  <span class="badge bg-danger mb-2">
                    <i class="fas fa-shield-alt me-1"></i>System Admin
                  </span>
                  }
                  @if (roomDetails.room.description) {
                  <p class="text-muted mb-3">{{ roomDetails.room.description }}</p>
                  }

                  <div class="row g-3">
                    <div class="col-sm-6">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-tasks text-info me-2"></i>
                        <span class="fw-semibold">Active Tasks:</span>
                        <span class="badge bg-info ms-2">{{
                          roomDetails.room.activeTaskCount
                        }}</span>
                      </div>
                    </div>
                    <div class="col-sm-6">
                      <div class="d-flex align-items-center text-muted">
                        <i class="fas fa-calendar me-2"></i>
                        <span>Created {{ roomDetails.room.createdAt | utcDate : 'medium' }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              @if (canManageRoom) {
              <div class="d-grid gap-2">
                @if (roomDetails.isOwner) {
                <a
                  [routerLink]="['/rooms', roomId, 'edit']"
                  [queryParams]="{ householdId: householdId }"
                  class="btn btn-warning"
                >
                  <i class="fas fa-edit me-1"></i>Edit Room
                </a>

                <button type="button" class="btn btn-outline-primary" (click)="openPhotoModal()">
                  <i class="fas fa-camera me-1"></i>Manage Photo
                </button>
                }

                <button type="button" class="btn btn-outline-danger" (click)="confirmDeleteRoom()">
                  <i class="fas fa-trash me-1"></i>Delete Room
                </button>
              </div>
              } @else {
              <a
                [routerLink]="['/rooms']"
                [queryParams]="{ householdId: householdId }"
                class="btn btn-outline-secondary"
              >
                <i class="fas fa-arrow-left me-1"></i>Back to Rooms
              </a>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Tasks -->
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-tasks text-info me-2"></i>
            Tasks in this Room ({{ roomDetails.activeTasks.length }})
          </h5>
          @if (canManageRoom) {
          <a
            [routerLink]="['/tasks', householdId, 'create']"
            [queryParams]="{ roomId: roomId }"
            class="btn btn-sm btn-info"
          >
            <i class="fas fa-plus me-1"></i>Add Task
          </a>
          }
        </div>
        <div class="card-body p-0">
          @if (roomDetails.activeTasks.length > 0) {
          <p-table
            [value]="roomDetails.activeTasks"
            [tableStyle]="{ 'min-width': '100%' }"
            styleClass="p-datatable-sm p-datatable-striped"
            [paginator]="roomDetails.activeTasks.length > 5"
            [rows]="rows"
            [rowsPerPageOptions]="rowsPerPageOptions"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} tasks"
          >
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 25%">Task</th>
                <th style="width: 10%">Type</th>
                <th style="width: 10%">Priority</th>
                <th style="width: 10%">Status</th>
                <th style="width: 15%">Assigned To</th>
                <th style="width: 15%">Due Date / Schedule</th>
                <th style="width: 15%" class="text-center">Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-task>
              <tr>
                <td>
                  <div class="task-info">
                    <h6 class="mb-0">
                      <a [routerLink]="['/tasks', householdId, task.id]">
                        {{ task.title }}
                      </a>
                    </h6>
                    @if (task.description) {
                    <small class="text-muted">
                      {{ task.description.length > 50 ? task.description.substring(0, 50) + '...' : task.description }}
                    </small>
                    }
                  </div>
                </td>
                <td>
                  @if (task.type === 1) {
                  <span class="badge bg-primary rounded-pill px-3 py-2">
                    <i class="fas fa-clock me-1"></i>One-Time
                  </span>
                  } @else {
                  <span class="badge bg-info rounded-pill px-3 py-2">
                    <i class="fas fa-redo me-1"></i>Regular
                  </span>
                  }
                </td>
                <td>
                  @switch (task.priority) {
                  @case (3) {
                  <span class="badge bg-danger rounded-pill px-3 py-2">
                    <i class="fas fa-exclamation-circle me-1"></i>High
                  </span>
                  }
                  @case (2) {
                  <span class="badge bg-warning text-dark rounded-pill px-3 py-2">
                    <i class="fas fa-exclamation-circle me-1"></i>Medium
                  </span>
                  }
                  @case (1) {
                  <span class="badge bg-success rounded-pill px-3 py-2">
                    <i class="fas fa-exclamation-circle me-1"></i>Low
                  </span>
                  }
                  }
                </td>
                <td>
                  @if (task.isActive) {
                  <span class="badge bg-success rounded-pill px-3 py-2">
                    <i class="fas fa-check-circle me-1"></i>Active
                  </span>
                  } @else {
                  <span class="badge bg-secondary rounded-pill px-3 py-2">
                    <i class="fas fa-times-circle me-1"></i>Inactive
                  </span>
                  }
                </td>
                <td>
                  @if (task.assignedUserName) {
                  <i class="fas fa-user text-muted me-1"></i>
                  <span>{{ task.assignedUserName }}</span>
                  } @else {
                  <span class="text-muted fst-italic">
                    <i class="fas fa-user-slash me-1"></i>Unassigned
                  </span>
                  }
                </td>
                <td>
                  @if (task.type === 1 && task.dueDate) {
                  <small>
                    <i class="far fa-calendar-alt me-1"></i>
                    {{ task.dueDate | utcDate : 'MMM d, y HH:mm' }}
                  </small>
                  } @else if (task.type === 0 && task.recurrenceRule) {
                  <small class="text-muted">
                    <i class="fas fa-redo me-1"></i>{{ formatRecurrenceRule(task.recurrenceRule) }}
                  </small>
                  } @else {
                  <span class="text-muted">N/A</span>
                  }
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <a
                      [routerLink]="['/tasks', householdId, task.id]"
                      class="btn btn-primary"
                      title="View Details"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                    @if (canManageRoom) {
                    <a
                      [routerLink]="['/tasks', householdId, task.id, 'edit']"
                      class="btn btn-warning"
                      title="Edit"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                    }
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
          } @else {
          <div class="text-center py-5">
            <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Tasks Yet</h5>
            <p class="text-muted mb-4">This room doesn't have any tasks.</p>
            @if (canManageRoom) {
            <a
              [routerLink]="['/tasks', householdId, 'create']"
              [queryParams]="{ roomId: roomId }"
              class="btn btn-info"
            >
              <i class="fas fa-plus me-1"></i>Create First Task
            </a>
            }
          </div>
          }
        </div>
      </div>
    </div>
  </div>
  }
</div>

<!-- Photo Modal -->
@if (showPhotoModal && roomDetails) {
<div class="modal fade show d-block" tabindex="-1" style="background: rgba(0, 0, 0, 0.5)">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title"><i class="fas fa-camera me-2"></i>Manage Room Photo</h5>
        <button type="button" class="btn-close" (click)="closePhotoModal()"></button>
      </div>
      <div class="modal-body">
        @if (roomDetails.room.photoUrl) {
        <div class="text-center mb-4">
          <img
            [src]="roomDetails.room.photoUrl | photoUrl"
            [alt]="roomDetails.room.name"
            class="img-fluid rounded shadow-sm"
            style="max-height: 200px"
          />
        </div>

        <div class="text-center mb-4">
          <button type="button" class="btn btn-outline-danger" (click)="deletePhoto()">
            <i class="fas fa-trash me-1"></i>Delete Current Photo
          </button>
        </div>

        <hr />
        }

        <h6>Upload New Photo</h6>
        <div class="mb-3">
          <input
            type="file"
            class="form-control"
            accept="image/*"
            (change)="onPhotoFileSelected($event)"
          />
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Supported formats: JPG, PNG, GIF, WebP. Max size: 5MB
          </div>
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-secondary me-2" (click)="closePhotoModal()">
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary"
            [disabled]="!selectedPhotoFile || isUploadingPhoto"
            (click)="uploadPhoto()"
          >
            @if (isUploadingPhoto) {
            <span class="spinner-border spinner-border-sm me-1"></span>
            }
            <i class="fas fa-upload me-1"></i>Upload Photo
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
}

<!-- Confirmation Dialog -->
<app-confirmation-dialog
  [show]="showConfirmDialog"
  [data]="confirmDialogData"
  (confirmed)="onDialogConfirmed()"
  (cancelled)="onDialogCancelled()"
></app-confirmation-dialog>
