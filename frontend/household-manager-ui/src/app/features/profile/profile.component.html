<div class="container py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col">
      <h1 class="h2 mb-1">
        <i class="fas fa-user-circle text-primary me-2"></i>My Profile
      </h1>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted mt-3">Loading profile...</p>
    </div>
  }

  <!-- Profile Content -->
  @else if (profile) {
    <div class="row">
      <!-- Left Column - Profile Info -->
      <div class="col-lg-8">
        <!-- Auth0 User Info Card (Read-only) -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">
              <i class="fas fa-shield-alt me-2 text-primary"></i>
              Account Information
            </h5>
          </div>
          <div class="card-body">
            @if (auth0User$ | async; as auth0User) {
              <div class="d-flex align-items-center">
                @if (auth0User.picture) {
                  <img [src]="auth0User.picture" 
                       alt="Profile picture"
                       class="rounded-circle me-3"
                       style="width: 80px; height: 80px; object-fit: cover;">
                } @else {
                  <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                       style="width: 80px; height: 80px;">
                    <i class="fas fa-user fa-2x"></i>
                  </div>
                }
                <div>
                  <h5 class="mb-1">{{ profile.user.fullName || auth0User.name || 'No Name' }}</h5>
                  <p class="text-muted mb-0">
                    <i class="fas fa-envelope me-1"></i>
                    {{ auth0User.email || profile.user.email }}
                  </p>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Editable Profile Information Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">
              <i class="fas fa-user-edit me-2"></i>Profile Information
            </h5>
          </div>
          <div class="card-body">
            <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="firstName" class="form-label">First Name</label>
                  <input type="text" 
                         id="firstName" 
                         formControlName="firstName" 
                         class="form-control"
                         [class.is-invalid]="firstName?.invalid && firstName?.touched"
                         placeholder="Enter your first name">
                  @if (firstName?.invalid && firstName?.touched) {
                    <div class="invalid-feedback">
                      First name cannot exceed 50 characters
                    </div>
                  }
                </div>

                <div class="col-md-6">
                  <label for="lastName" class="form-label">Last Name</label>
                  <input type="text" 
                         id="lastName" 
                         formControlName="lastName" 
                         class="form-control"
                         [class.is-invalid]="lastName?.invalid && lastName?.touched"
                         placeholder="Enter your last name">
                  @if (lastName?.invalid && lastName?.touched) {
                    <div class="invalid-feedback">
                      Last name cannot exceed 50 characters
                    </div>
                  }
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Member Since</label>
                <input type="text" 
                       class="form-control" 
                       [value]="profile.user.createdAt | utcDate:'longDate'" 
                       disabled 
                       readonly>
              </div>

              <div class="d-flex gap-2">
                <button type="submit" 
                        class="btn btn-primary"
                        [disabled]="isSubmitting || profileForm.invalid || profileForm.pristine">
                  @if (isSubmitting) {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Saving...
                  } @else {
                    <i class="fas fa-save me-2"></i>
                    Save Changes
                  }
                </button>
                <button type="button" 
                        class="btn btn-outline-secondary"
                        (click)="profileForm.reset(); loadProfile()"
                        [disabled]="isSubmitting">
                  <i class="fas fa-undo me-2"></i>Reset
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Account Security Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">
              <i class="fas fa-shield-alt me-2"></i>Account Security
            </h5>
          </div>
          <div class="card-body">
            @if (connectionInfo) {
              <!-- Connection Type Info -->
              <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Connection Type:</strong> {{ connectionInfo.providerName }}
              </div>

              <!-- Change Password Section -->
              @if (connectionInfo.canChangePassword) {
                <div class="mb-4 pb-4 border-bottom">
                  <h6 class="mb-3">
                    <i class="fas fa-key me-2"></i>Password
                  </h6>
                  <p class="text-muted mb-3">
                    Change your password securely through Auth0's hosted page.
                  </p>
                  <button type="button"
                          class="btn btn-outline-primary"
                          (click)="onChangePassword()"
                          [disabled]="isChangingPassword">
                    @if (isChangingPassword) {
                      <span class="spinner-border spinner-border-sm me-2"></span>
                      Redirecting...
                    } @else {
                      <i class="fas fa-key me-2"></i>
                      Change Password
                    }
                  </button>
                </div>
              } @else {
                <div class="alert alert-warning mb-4">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>Social Login:</strong> Password management is handled by {{ connectionInfo.providerName }}.
                  Please change your password in your {{ connectionInfo.providerName }} account.
                </div>
              }

              <!-- Change Email Section -->
              @if (connectionInfo.canChangeEmail) {
                <div>
                  <h6 class="mb-3">
                    <i class="fas fa-envelope me-2"></i>Email Address
                  </h6>
                  <p class="text-muted mb-3">
                    Update your email address. You will be logged out to refresh your session.
                  </p>
                  <form [formGroup]="emailForm" (ngSubmit)="onChangeEmail()">
                    <div class="mb-3">
                      <label for="newEmail" class="form-label">New Email</label>
                      <input type="email"
                             id="newEmail"
                             formControlName="newEmail"
                             class="form-control"
                             [class.is-invalid]="newEmail?.invalid && newEmail?.touched"
                             placeholder="Enter new email address">
                      @if (newEmail?.invalid && newEmail?.touched) {
                        <div class="invalid-feedback">
                          @if (newEmail?.errors?.['required']) {
                            Email is required
                          }
                          @if (newEmail?.errors?.['email']) {
                            Please enter a valid email address
                          }
                          @if (newEmail?.errors?.['maxlength']) {
                            Email cannot exceed 255 characters
                          }
                        </div>
                      }
                    </div>
                    <button type="submit"
                            class="btn btn-outline-primary"
                            [disabled]="isChangingEmail || emailForm.invalid || emailForm.pristine">
                      @if (isChangingEmail) {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Changing Email...
                      } @else {
                        <i class="fas fa-envelope me-2"></i>
                        Change Email
                      }
                    </button>
                  </form>
                </div>
              } @else {
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>Social Login:</strong> Email management is handled by {{ connectionInfo.providerName }}.
                  Please change your email in your {{ connectionInfo.providerName }} account.
                </div>
              }
            } @else {
              <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-muted" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-2 mb-0">Loading account settings...</p>
              </div>
            }
          </div>
        </div>

        <!-- Account Actions Card -->
        <div class="card shadow-sm border-warning">
          <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0">
              <i class="fas fa-sign-out-alt me-2"></i>Account Actions
            </h5>
          </div>
          <div class="card-body">
            <p class="mb-3">
              Sign out of your Household Manager account
            </p>
            <button type="button" class="btn btn-warning" (click)="logout()">
              <i class="fas fa-sign-out-alt me-2"></i>Sign Out
            </button>
          </div>
        </div>
      </div>

      <!-- Right Column - Statistics -->
      <div class="col-lg-4">
        <!-- Activity Statistics Card -->
        <div class="card shadow-sm mb-4 sticky-top" style="top: 20px;">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">
              <i class="fas fa-chart-bar me-2"></i>Activity Statistics
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">
                  <i class="fas fa-home me-2"></i>Total Households
                </span>
                <strong class="h4 mb-0 text-primary">{{ profile.stats.totalHouseholds }}</strong>
              </div>
            </div>

            <div class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">
                  <i class="fas fa-crown me-2"></i>Owned Households
                </span>
                <strong class="h4 mb-0 text-warning">{{ profile.stats.ownedHouseholds }}</strong>
              </div>
            </div>

            <div class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">
                  <i class="fas fa-tasks me-2"></i>Active Tasks
                </span>
                <strong class="h4 mb-0 text-info">{{ profile.stats.activeTasks }}</strong>
              </div>
            </div>

            <div>
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">
                  <i class="fas fa-check-circle me-2"></i>Completed This Week
                </span>
                <strong class="h4 mb-0 text-success">{{ profile.stats.completedTasksThisWeek }}</strong>
              </div>
            </div>

            @if (profile.stats.lastActivity) {
              <hr>
              <div class="text-center">
                <small class="text-muted">
                  <i class="fas fa-clock me-1"></i>
                  Last activity: {{ profile.stats.lastActivity | utcDate:'medium' }}
                </small>
              </div>
            }
          </div>
        </div>

      </div>
    </div>
  }
</div>