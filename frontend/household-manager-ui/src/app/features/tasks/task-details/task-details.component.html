<div class="container py-4">
  @if (taskDetails) {
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a routerLink="/households" class="text-decoration-none">
            <i class="fas fa-home me-1"></i>My Households
          </a>
        </li>
        @if (householdName) {
          <li class="breadcrumb-item">
            <a [routerLink]="['/households', householdId]" class="text-decoration-none">
              {{ householdName }}
            </a>
          </li>
        }
        <li class="breadcrumb-item">
          <a [routerLink]="['/tasks', householdId]" class="text-decoration-none">
            Tasks
          </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          {{ taskDetails.task.title }}
        </li>
      </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
      <div class="col">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
          <div class="flex-grow-1">
            <h1 class="h3 mb-2">
              <i class="fas fa-tasks text-info me-2"></i>
              {{ taskDetails.task.title }}
            </h1>
            <div class="d-flex gap-2 flex-wrap">
              <span class="badge" [ngClass]="getPriorityBadgeClass(taskDetails.task.priority)">
                <i class="fas fa-exclamation-circle me-1"></i>{{ TaskPriority[taskDetails.task.priority] }} Priority
              </span>
              @if (taskDetails.task.isActive) {
                <span class="badge bg-success">
                  <i class="fas fa-check me-1"></i>Active
                </span>
              } @else {
                <span class="badge bg-secondary">
                  <i class="fas fa-pause me-1"></i>Inactive
                </span>
              }
              @if (taskDetails.task.isOverdue) {
                <span class="badge bg-danger">
                  <i class="fas fa-exclamation-triangle me-1"></i>Overdue
                </span>
              }
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-2 mt-3 mt-md-0 flex-wrap">
            <a [routerLink]="['/tasks', householdId]"
               class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left me-1"></i>Back
            </a>

            @if (canEdit) {
              <a [routerLink]="['/tasks', householdId, taskId, 'edit']"
                 class="btn btn-warning">
                <i class="fas fa-edit me-1"></i>Edit
              </a>
            }

            @if (isOwner) {
              @if (taskDetails.task.isActive) {
                <button type="button"
                        class="btn btn-secondary"
                        (click)="deactivateTask()">
                  <i class="fas fa-pause me-1"></i>Deactivate
                </button>
              } @else {
                <button type="button"
                        class="btn btn-success"
                        (click)="activateTask()">
                  <i class="fas fa-play me-1"></i>Activate
                </button>
              }
            }

            @if (canDelete) {
              <button type="button"
                      class="btn btn-danger"
                      (click)="confirmDeleteTask()">
                <i class="fas fa-trash me-1"></i>Delete
              </button>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-8">
        <!-- Task Details Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">
              <i class="fas fa-info-circle me-2"></i>Task Details
            </h5>
          </div>
          <div class="card-body">
            <table class="table table-borderless">
              <tbody>
                <tr>
                  <th style="width: 35%;">
                    <i class="fas fa-door-open text-muted me-2"></i>Room
                  </th>
                  <td>{{ taskDetails.room.name }}</td>
                </tr>
                <tr>
                  <th>
                    <i class="fas fa-user text-muted me-2"></i>Assigned To
                  </th>
                  <td>
                    @if (taskDetails.task.assignedUserName) {
                      <span>
                        {{ taskDetails.task.assignedUserName }}
                        @if (taskDetails.permissions.isAssignedToCurrentUser) {
                          <span class="badge bg-primary ms-1">You</span>
                        }
                      </span>
                    } @else {
                      <span class="text-muted">
                        <i class="fas fa-user-slash me-1"></i>Unassigned
                      </span>
                    }
                  </td>
                </tr>
                <tr>
                  <th>
                    <i class="fas fa-layer-group text-muted me-2"></i>Task Type
                  </th>
                  <td>
                    @if (taskDetails.task.type === TaskType.Regular) {
                      <span class="badge bg-primary">
                        <i class="fas fa-repeat me-1"></i>Regular
                      </span>
                      @if (taskDetails.task.scheduledWeekday !== undefined) {
                        <span class="ms-2">
                          <i class="fas fa-calendar-week me-1"></i>
                          {{ getWeekdayName(taskDetails.task.scheduledWeekday) }}
                        </span>
                      }
                    } @else {
                      <span class="badge bg-info">
                        <i class="fas fa-calendar-day me-1"></i>One-Time
                      </span>
                    }
                  </td>
                </tr>
                @if (taskDetails.task.type === TaskType.OneTime) {
                  <tr>
                    <th>
                      <i class="fas fa-clock text-muted me-2"></i>
                      Due Date
                    </th>
                    <td>
                      @if (taskDetails.task.dueDate) {
                        <span [class.text-danger]="taskDetails.task.isOverdue" 
                              [class.fw-bold]="taskDetails.task.isOverdue">
                          {{ taskDetails.task.dueDate | utcDate:'medium' }}
                          @if (taskDetails.task.isOverdue) {
                            <i class="fas fa-exclamation-triangle text-danger ms-1"></i>
                          }
                        </span>
                      }
                    </td>
                  </tr>
                }
                <tr>
                  <th>
                    <i class="fas fa-calendar-plus text-muted me-2"></i>Created
                  </th>
                  <td>{{ taskDetails.task.createdAt | utcDate:'medium' }}</td>
                </tr>
                @if (taskDetails.task.isCompletedThisWeek && taskDetails.task.type === TaskType.Regular) {
                  <tr>
                    <th>
                      <i class="fas fa-check-double text-muted me-2"></i>Status
                    </th>
                    <td>
                      <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>Completed This Week
                      </span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>

            @if (taskDetails.task.description) {
              <hr />
              <div>
                <h6 class="text-muted mb-2">
                  <i class="fas fa-align-left me-2"></i>Description
                </h6>
                <p class="mb-0">{{ taskDetails.task.description }}</p>
              </div>
            }
          </div>
        </div>

        <!-- Execution History Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">
              <i class="fas fa-history me-2"></i>Execution History
            </h5>
          </div>
          <div class="card-body">
            <app-execution-history [taskId]="taskId" [limit]="5"></app-execution-history>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <!-- Complete Task Form -->
        @if (canShowCompleteForm) {
          <div class="card shadow-sm mb-4" id="completeForm">
            <div class="card-header bg-success text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-check-circle me-2"></i>Complete Task
              </h5>
            </div>
            <div class="card-body">
              <form [formGroup]="completeForm" (ngSubmit)="onCompleteTask()">
                <!-- Notes -->
                <div class="mb-3">
                  <label for="notes" class="form-label">
                    <i class="fas fa-comment me-1"></i>Notes (Optional)
                  </label>
                  <textarea formControlName="notes" 
                            id="notes" 
                            class="form-control" 
                            rows="3"
                            placeholder="Add any notes about completing this task..."></textarea>
                </div>

                <!-- Photo Upload -->
                <div class="mb-3">
                  <label for="photo" class="form-label">
                    <i class="fas fa-camera me-1"></i>Photo (Optional)
                  </label>
                  <input type="file" 
                         id="photo" 
                         class="form-control"
                         accept="image/jpeg,image/png,image/gif,image/webp"
                         (change)="onPhotoSelected($event)">
                  <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Upload a photo showing the completed task (max 5MB)
                  </div>

                  <!-- Photo Preview -->
                  @if (photoPreviewUrl) {
                    <div class="mt-2 position-relative" style="max-width: 300px;">
                      <img [src]="photoPreviewUrl" 
                           alt="Preview" 
                           class="img-thumbnail d-block"
                           style="max-height: 200px; width: auto;">
                      <button type="button" 
                              class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2"
                              (click)="removePhoto()"
                              title="Remove photo">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  }
                </div>

                <!-- Submit Button -->
                <div class="d-grid">
                  <button type="submit" 
                          class="btn btn-success btn-lg"
                          [disabled]="isSubmitting || completeForm.invalid">
                    @if (isSubmitting) {
                      <span class="spinner-border spinner-border-sm me-2"></span>
                      Completing...
                    } @else {
                      <i class="fas fa-check me-2"></i>
                      Complete Task
                    }
                  </button>
                </div>
              </form>
            </div>
          </div>
        }

        <!-- Already Completed This Week Notice (Regular) -->
        @if (canComplete && taskDetails.task.isActive && hasCompletedThisWeek) {
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0">
                <i class="fas fa-check-double me-2"></i>Already Completed
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-success d-flex align-items-center mb-3">
                <i class="fas fa-check-circle me-2"></i>
                This task has already been completed this week. You can complete it again next week.
              </div>
              
              @if (isOwner) {
                <hr class="my-3" />
                <div class="alert alert-warning mb-0">
                  <h6 class="alert-heading">
                    <i class="fas fa-crown me-1"></i>Owner Actions
                  </h6>
                  <p class="mb-2 small">
                    As the household owner, you can reset this task's completion status to allow it to be completed again this week. 
                    The previous execution will remain in the history but won't count toward completion.
                  </p>
                  <button type="button" 
                          class="btn btn-warning btn-sm"
                          (click)="invalidateExecutionThisWeek()">
                    <i class="fas fa-redo me-1"></i>
                    Reset Completion Status
                  </button>
                </div>
              }
            </div>
          </div>
        }

        <!-- One-Time Completed Notice -->
        @if (canComplete && taskDetails.task.isActive && isOneTimeCompleted) {
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0">
                <i class="fas fa-check me-2"></i>Task Completed
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-success d-flex flex-wrap align-items-center mb-0">
                <i class="fas fa-check-circle me-2"></i>
                <span>
                  This one-time task has already been completed
                  @if (taskDetails.stats.lastCompleted) {
                    on <strong>{{ taskDetails.stats.lastCompleted | utcDate:'medium' }}</strong>
                  }.
                </span>
              </div>
            </div>
          </div>
        }

        <!-- Inactive Task Notice -->
        @if (canComplete && !taskDetails.task.isActive) {
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0">
                <i class="fas fa-pause me-2"></i>Task Inactive
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-secondary d-flex align-items-center mb-0">
                <i class="fas fa-info-circle me-2"></i>
                This task is currently inactive and cannot be completed.
              </div>
            </div>
          </div>
        }

      </div>
    </div>

    <!-- Confirmation Dialog -->
    <app-confirmation-dialog
      [show]="showConfirmDialog"
      [data]="confirmDialogData"
      (confirmed)="onConfirmDialogConfirmed()"
      (cancelled)="onConfirmDialogCancelled()">
    </app-confirmation-dialog>
  }
</div>