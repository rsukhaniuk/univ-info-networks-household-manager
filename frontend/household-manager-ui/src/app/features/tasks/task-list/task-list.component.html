<div class="container py-4">
  <!-- Header -->
  <div class="row justify-content-center mb-4">
    <div class="col-lg-10">
      <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
          <h1 class="h3 mb-1">
            <i class="fas fa-tasks text-primary me-2"></i>
            Tasks
            @if (isSystemAdmin$ | async) {
              <span class="badge bg-danger ms-2">System Admin</span>
            }
          </h1>
          <p class="text-muted mb-0">Manage and track household tasks</p>
        </div>

        <div class="d-flex gap-2">
          <a [routerLink]="['/households', householdId, 'tasks', 'create']" 
             class="btn btn-success">
            <i class="fas fa-plus me-1"></i>Create Task
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages -->
  @if (successMessage) {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="fas fa-check-circle me-2"></i>
      {{ successMessage }}
      <button type="button" class="btn-close" (click)="successMessage = null"></button>
    </div>
  }

  @if (error) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      {{ error }}
      <button type="button" class="btn-close" (click)="error = null"></button>
    </div>
  }

  <!-- Filters Card -->
  <div class="row justify-content-center mb-4">
    <div class="col-lg-10">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-filter me-2"></i>Filters
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">
                <i class="fas fa-exclamation-circle me-1"></i>Priority
              </label>
              <select class="form-select" 
                      [value]="queryParams.priority || ''"
                      (change)="onFilterChange('priority', $any($event.target).value)">
                <option value="">All Priorities</option>
                <option [value]="TaskPriority.Low">Low</option>
                <option [value]="TaskPriority.Medium">Medium</option>
                <option [value]="TaskPriority.High">High</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label">
                <i class="fas fa-toggle-on me-1"></i>Status
              </label>
              <select class="form-select" 
                      (change)="onFilterChange('isActive', $any($event.target).value === 'true' ? true : $any($event.target).value === 'false' ? false : undefined)">
                <option value="">All Status</option>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">
                <i class="fas fa-search me-1"></i>Search
              </label>
              <input type="text" 
                     class="form-control" 
                     placeholder="Search tasks..."
                     [value]="queryParams.search || ''"
                     (input)="onSearch($any($event.target).value)">
            </div>

            <div class="col-md-2 d-flex align-items-end">
              <button type="button" 
                      class="btn btn-outline-secondary w-100"
                      (click)="clearFilters()">
                <i class="fas fa-times me-1"></i>Clear
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted mt-3">Loading tasks...</p>
    </div>
  }

  <!-- Empty State -->
  @else if (tasks.length === 0) {
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card shadow-sm">
          <div class="card-body text-center py-5">
            <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Tasks Found</h4>
            <p class="text-muted mb-4">
              @if (queryParams.search || queryParams.priority || queryParams.isActive !== undefined) {
                No tasks match your current filters. Try adjusting the filters above.
              } @else {
                This household doesn't have any tasks yet. Create your first task to get started!
              }
            </p>
            <a [routerLink]="['/households', householdId, 'tasks', 'create']" 
               class="btn btn-success btn-lg">
              <i class="fas fa-plus me-1"></i>Create First Task
            </a>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Tasks Table -->
  @else {
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card shadow-sm">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">
              <i class="fas fa-list me-2"></i>
              Tasks ({{ pagedResult?.totalCount || 0 }})
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th (click)="onSort('title')" style="cursor: pointer;">
                      <i class="fas fa-tasks me-1"></i>Title
                      @if (queryParams.sortBy === 'title') {
                        <i class="fas fa-sort-{{ queryParams.sortOrder === 'asc' ? 'up' : 'down' }} ms-1"></i>
                      }
                    </th>
                    <th><i class="fas fa-door-open me-1"></i>Room</th>
                    <th (click)="onSort('priority')" style="cursor: pointer;">
                      <i class="fas fa-exclamation-circle me-1"></i>Priority
                      @if (queryParams.sortBy === 'priority') {
                        <i class="fas fa-sort-{{ queryParams.sortOrder === 'asc' ? 'up' : 'down' }} ms-1"></i>
                      }
                    </th>
                    <th><i class="fas fa-user me-1"></i>Assigned</th>
                    <th><i class="fas fa-calendar me-1"></i>Due Date</th>
                    <th><i class="fas fa-cogs me-1"></i>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (task of tasks; track task.id) {
                    <tr [class.table-primary]="isAssignedToCurrentUser(task)"
                        [class.table-danger]="task.isOverdue">
                      <!-- Title -->
                      <td>
                        <div>
                          <h6 class="mb-0">
                            <a [routerLink]="['/households', householdId, 'tasks', task.id]" 
                               class="text-decoration-none">
                              {{ task.title }}
                            </a>
                            @if (isAssignedToCurrentUser(task)) {
                              <span class="badge bg-primary ms-1">You</span>
                            }
                          </h6>
                          @if (task.description) {
                            <small class="text-muted">
                              {{ task.description.length > 60 ? task.description.substring(0, 60) + '...' : task.description }}
                            </small>
                          }
                        </div>
                      </td>

                      <!-- Room -->
                      <td>
                        <i class="fas fa-door-open text-muted me-1"></i>
                        {{ task.roomName }}
                      </td>

                      <!-- Priority -->
                      <td>
                        <span class="badge" [ngClass]="getPriorityBadgeClass(task.priority)">
                          {{ TaskPriority[task.priority] }}
                        </span>
                      </td>

                      <!-- Assigned -->
                      <td>
                        @if (task.assignedUserName) {
                          <i class="fas fa-user text-muted me-1"></i>
                          {{ task.assignedUserName }}
                        } @else {
                          <span class="text-muted">
                            <i class="fas fa-user-slash me-1"></i>Unassigned
                          </span>
                        }
                      </td>

                      <!-- Due Date -->
                      <td>
                        @if (task.type === TaskType.OneTime && task.dueDate) {
                          <i class="fas fa-calendar-alt text-muted me-1"></i>
                          <span [class.text-danger]="task.isOverdue" [class.fw-bold]="task.isOverdue">
                            {{ task.dueDate | utcDate:'short' }}
                          </span>
                        } @else if (task.type === TaskType.Regular && task.scheduledWeekday !== undefined) {
                          <i class="fas fa-calendar-week text-muted me-1"></i>
                          {{ task.scheduledWeekday }}
                        } @else {
                          <span class="text-muted">N/A</span>
                        }
                      </td>

                      <!-- Actions -->
                      <td>
                        <div class="btn-group btn-group-sm" role="group">
                          <a [routerLink]="['/households', householdId, 'tasks', task.id]" 
                             class="btn btn-primary" 
                             title="View Details">
                            <i class="fas fa-eye"></i>
                          </a>
                          
                          <a [routerLink]="['/households', householdId, 'tasks', task.id, 'edit']" 
                             class="btn btn-warning" 
                             title="Edit">
                            <i class="fas fa-edit"></i>
                          </a>
                          
                          <button type="button" 
                                  class="btn btn-danger" 
                                  (click)="deleteTask(task.id, task.title)" 
                                  title="Delete">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            @if (pagedResult && pagedResult.totalPages > 1) {
              <nav>
                <ul class="pagination justify-content-center">
                  <li class="page-item" [class.disabled]="!pagedResult.hasPreviousPage">
                    <button class="page-link" (click)="onPageChange(pagedResult.pageNumber - 1)">
                      Previous
                    </button>
                  </li>
                  @for (page of [].constructor(pagedResult.totalPages); track $index) {
                    <li class="page-item" [class.active]="pagedResult.pageNumber === $index + 1">
                      <button class="page-link" (click)="onPageChange($index + 1)">
                        {{ $index + 1 }}
                      </button>
                    </li>
                  }
                  <li class="page-item" [class.disabled]="!pagedResult.hasNextPage">
                    <button class="page-link" (click)="onPageChange(pagedResult.pageNumber + 1)">
                      Next
                    </button>
                  </li>
                </ul>
              </nav>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>