<div class="container task-form-container">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a routerLink="/households" class="text-decoration-none">
              <i class="fas fa-home me-1"></i>My Households
            </a>
          </li>
          @if (householdId) {
          <li class="breadcrumb-item">
            <a [routerLink]="['/households', householdId]" class="text-decoration-none">
              Household
            </a>
          </li>
          <li class="breadcrumb-item">
            <a [routerLink]="['/tasks', householdId]" class="text-decoration-none">
              Tasks
            </a>
          </li>
          }
          <li class="breadcrumb-item active" aria-current="page">
            {{ isEdit ? 'Edit' : 'Create' }}
          </li>
        </ol>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <div class="row justify-content-center mb-4">
    <div class="col-lg-10">
      <div class="text-center">
        <h1 class="h3 mb-1">
          <i class="fas fa-{{ isEdit ? 'edit' : 'plus' }} text-info me-2"></i>
          {{ isEdit ? 'Edit Task' : 'Create Task' }}
        </h1>
        <p class="text-muted mb-0">
          @if (isEdit) {
            Update task details and settings
          } @else {
            Create a new task for your household
          }
        </p>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }

  <!-- Form -->
  @else {
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <form [formGroup]="form" (ngSubmit)="onSubmit()">
          <!-- Basic Information Card -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0">
                <i class="fas fa-info-circle text-info me-2"></i>Basic Information
              </h5>
            </div>
            <div class="card-body p-4">
              <!-- Title -->
              <div class="mb-4">
                <label for="title" class="form-label fw-semibold">
                  <i class="fas fa-tasks text-info me-2"></i>
                  Task Title <span class="text-danger">*</span>
                </label>
                <input type="text" 
                       id="title" 
                       formControlName="title" 
                       class="form-control form-control-lg"
                       [class.is-invalid]="title?.invalid && title?.touched"
                       placeholder="e.g., Clean kitchen, Take out trash"
                       maxlength="200">
                @if (title?.invalid && title?.touched) {
                  <div class="invalid-feedback">
                    @if (title?.errors?.['required']) {
                      Task title is required
                    }
                    @if (title?.errors?.['maxlength']) {
                      Title cannot exceed 200 characters
                    }
                  </div>
                }
              </div>

              <!-- Description -->
              <div class="mb-4">
                <label for="description" class="form-label fw-semibold">
                  <i class="fas fa-align-left text-secondary me-2"></i>
                  Description <span class="text-muted">(optional)</span>
                </label>
                <textarea id="description" 
                          formControlName="description" 
                          class="form-control" 
                          rows="3"
                          [class.is-invalid]="description?.invalid && description?.touched"
                          placeholder="Provide additional details about this task..."
                          maxlength="1000"></textarea>
                @if (description?.invalid && description?.touched) {
                  <div class="invalid-feedback">
                    Description cannot exceed 1000 characters
                  </div>
                }
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  {{ description?.value?.length || 0 }} / 1000 characters
                </div>
              </div>

              <!-- General Task Checkbox -->
              @if (generalRoom) {
                <div class="mb-4">
                  <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           id="isGeneralTask"
                           [(ngModel)]="isGeneralTask"
                           [ngModelOptions]="{standalone: true}"
                           (change)="onGeneralTaskChange(isGeneralTask)">
                    <label class="form-check-label" for="isGeneralTask">
                      <i class="fas fa-home text-primary me-2"></i>
                      <strong>General household task</strong>
                      <small class="text-muted d-block ms-4">
                        This task is not specific to any room
                      </small>
                    </label>
                  </div>
                </div>
              }

              <!-- Room -->
              <div class="mb-4">
                <label for="roomId" class="form-label fw-semibold">
                  <i class="fas fa-door-open text-success me-2"></i>
                  Room <span class="text-danger">*</span>
                </label>
                <select id="roomId"
                        formControlName="roomId"
                        class="form-select form-select-lg"
                        [class.is-invalid]="roomId?.invalid && roomId?.touched"
                        [disabled]="isGeneralTask">
                  <option value="">-- Select Room --</option>
                  @for (room of rooms; track room.id) {
                    <option [value]="room.id">{{ room.name }}</option>
                  }
                </select>
                @if (roomId?.invalid && roomId?.touched) {
                  <div class="invalid-feedback">Please select a room</div>
                }
                @if (isGeneralTask) {
                  <div class="form-text text-success">
                    <i class="fas fa-check-circle me-1"></i>
                    General room automatically selected
                  </div>
                }
              </div>
            </div>
          </div>

          <!-- Scheduling Card -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0">
                <i class="fas fa-calendar-alt text-primary me-2"></i>Scheduling
              </h5>
            </div>
            <div class="card-body p-4">
              <!-- Task Type -->
              <div class="mb-4">
                <label class="form-label fw-semibold">
                  <i class="fas fa-sync-alt text-primary me-2"></i>
                  Task Type <span class="text-danger">*</span>
                </label>
                <div class="btn-group w-100" role="group">
                  <input type="radio"
                         class="btn-check"
                         id="typeOneTime"
                         [value]="TaskType.OneTime"
                         formControlName="type">
                  <label class="btn btn-outline-primary" for="typeOneTime">
                    <i class="fas fa-calendar-day me-1"></i>One-Time
                  </label>

                  <input type="radio"
                         class="btn-check"
                         id="typeRegular"
                         [value]="TaskType.Regular"
                         formControlName="type">
                  <label class="btn btn-outline-info" for="typeRegular">
                    <i class="fas fa-calendar-week me-1"></i>Regular
                  </label>
                </div>
              </div>

              <!-- âœ… Due Date (One-Time tasks) -->
              @if (type?.value === TaskType.OneTime) {
                <div class="mb-4">
                  <label for="dueDate" class="form-label fw-semibold">
                    <i class="fas fa-calendar-alt text-danger me-2"></i>
                    Due Date & Time <span class="text-danger">*</span>
                  </label>
                  <input type="text"
                         id="dueDate"
                         formControlName="dueDate"
                         class="form-control form-control-lg"
                         [class.is-invalid]="dueDate?.invalid && dueDate?.touched"
                         placeholder="Click to select date and time..."
                         mwlFlatpickr
                         [options]="flatpickrOptions"
                         readonly>
                  @if (dueDate?.errors?.['required'] && dueDate?.touched) {
                    <div class="invalid-feedback d-block">Due date and time are required</div>
                  }
                  @if (dueDate?.errors?.['pastDate'] && dueDate?.touched) {
                    <div class="invalid-feedback d-block">
                      <i class="fas fa-exclamation-triangle me-1"></i>
                      Due date must be in the future. Please select a later time.
                    </div>
                  }
                </div>
              }

              <!-- Recurrence Rule (Regular tasks) -->
              @if (type?.value === TaskType.Regular) {
                <div class="mb-4">
                  <app-recurrence-rule-builder
                    formControlName="recurrenceRule"
                    [required]="true">
                  </app-recurrence-rule-builder>
                  @if (recurrenceRule?.invalid && recurrenceRule?.touched) {
                    <div class="invalid-feedback d-block">
                      Please configure the recurrence pattern
                    </div>
                  }
                </div>
              }

            </div>
          </div>

          <!-- Task Settings Card -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0">
                <i class="fas fa-cog text-secondary me-2"></i>Task Settings
              </h5>
            </div>
            <div class="card-body p-4">
              <!-- Priority -->
              <div class="mb-4">
                <label class="form-label fw-semibold">
                  <i class="fas fa-exclamation-circle text-warning me-2"></i>
                  Priority <span class="text-danger">*</span>
                </label>
                <div class="btn-group w-100 priority-selector" role="group">
                  <input type="radio" 
                         class="btn-check" 
                         id="priorityLow" 
                         [value]="TaskPriority.Low"
                         formControlName="priority">
                  <label class="btn btn-outline-success" for="priorityLow">
                    <i class="fas fa-arrow-down me-1"></i>Low
                  </label>

                  <input type="radio" 
                         class="btn-check" 
                         id="priorityMedium" 
                         [value]="TaskPriority.Medium"
                         formControlName="priority">
                  <label class="btn btn-outline-warning" for="priorityMedium">
                    <i class="fas fa-minus me-1"></i>Medium
                  </label>

                  <input type="radio" 
                         class="btn-check" 
                         id="priorityHigh" 
                         [value]="TaskPriority.High"
                         formControlName="priority">
                  <label class="btn btn-outline-danger" for="priorityHigh">
                    <i class="fas fa-arrow-up me-1"></i>High
                  </label>
                </div>
              </div>

              <!-- Assigned User -->
              <div class="mb-4">
                <label for="assignedUserId" class="form-label fw-semibold">
                  <i class="fas fa-user text-primary me-2"></i>
                  Assign To <span class="text-muted">(optional)</span>
                </label>
                <select id="assignedUserId"
                        formControlName="assignedUserId"
                        class="form-select form-select-lg"
                        [class.is-invalid]="assignedUserId?.invalid && assignedUserId?.touched">
                  <option value="">-- Unassigned --</option>
                  @for (member of members; track member.userId) {
                    <option [value]="member.userId">{{ member.userName || member.email }}</option>
                  }
                </select>
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Choose who will be responsible for this task
                </div>
                @if (assignedUserId?.invalid && assignedUserId?.touched) {
                  <div class="invalid-feedback">Please assign this task to a member</div>
                }
              </div>

              <!-- Active Status -->
              <div class="form-check form-switch">
                <input type="checkbox" 
                       id="isActive" 
                       formControlName="isActive" 
                       class="form-check-input">
                <label for="isActive" class="form-check-label fw-semibold">
                  <i class="fas fa-toggle-on me-1"></i>Task is Active
                </label>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="card shadow-sm">
            <div class="card-body p-4">
              <div class="row g-3">
                <div class="col-sm-6">
                  <button type="button" (click)="onCancel()" 
                          class="btn btn-outline-secondary w-100">
                    <i class="fas fa-times me-2"></i>Cancel
                  </button>
                </div>
                <div class="col-sm-6">
                  <button type="submit" 
                          class="btn btn-info w-100"
                          [disabled]="form.invalid || form.pristine">
                    <i class="fas fa-{{ isEdit ? 'save' : 'plus' }} me-2"></i>
                    {{ isEdit ? 'Save Changes' : 'Create Task' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  }
</div>